<!DOCTYPE html>
<html lang="en-EN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta content="keyword 1, keyword 2, keyword 3" name="keywords">
<meta content="CryptoPatrick" name="author">
<meta property="og:title" content="ðŸ’» MVCC 101 - Seamless Global Nature">
<meta property="og:url" content="https://www.cryptopatrick.com/blog/2023/08/20/mvcc-101/">
<meta property="og:description" content="">
<meta property="og:type" content="website" />



<title>ðŸ’» MVCC 101 | Seamless Global Nature</title>

<link rel="stylesheet" href="https://www.cryptopatrick.com//css/style.css">
<link rel="stylesheet" href="https://www.cryptopatrick.com//css/customcode.css">

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />

<link rel="stylesheet"
      href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.0/build/styles/default.min.css">

</head>

<body>
<section class="section">
  <div class="container">
    <nav class="nav">

 <img src="../../../../../profile.jpg" alt="Avatar" style="margin-right: 1em" height="100px">
      <div class="nav-left" style="flex-basis: auto;">
        <a class="nav-item" href="https://www.cryptopatrick.com/"><h1 class="title is-4">Seamless Global Nature</h1></a>
      <nav class="nav-item level is-mobile">
          
          
          <a class="level-item" href="https://www.cryptopatrick.com/about/" style="display: flex; align-items: center;">
            
            <span class="icon" style="margin-right: 0.175em; display: flex; align-items: center;">
              <i class="fa fa-male"></i>
            </span>
            
            About Me
          </a>
          
          <a class="level-item" href="https://www.cryptopatrick.com/tags/" style="display: flex; align-items: center;">
            
            <span class="icon" style="margin-right: 0.175em; display: flex; align-items: center;">
              <i class="fa fa-tags"></i>
            </span>
            
            Tags
          </a>
          
          <a class="level-item" href="https://100-days-of-vibe.vercel.app" style="display: flex; align-items: center;">
            
            <span class="icon" style="margin-right: 0.175em; display: flex; align-items: center;">
              <i class="fa fa-paper-plane"></i>
            </span>
            
            100DaysOfVibe
          </a>
          
          <a class="level-item" href="https://x.com/cryptopatrick" style="display: flex; align-items: center;">
            
            <span class="icon" style="margin-right: 0.175em; display: flex; align-items: center;">
              <i class="fa fa-twitter"></i>
            </span>
            
             
          </a>
          
          <a class="level-item" href="https://github.com/cryptopatrick?tab=repositories" style="display: flex; align-items: center;">
            
            <span class="icon" style="margin-right: 0.175em; display: flex; align-items: center;">
              <i class="fa fa-github"></i>
            </span>
            
             
          </a>
          
          <a class="level-item" href="https://www.instagram.com/cryptopatrickk/" style="display: flex; align-items: center;">
            
            <span class="icon" style="margin-right: 0.175em; display: flex; align-items: center;">
              <i class="fa fa-instagram"></i>
            </span>
            
             
          </a>
          
        </nav>
      </div>
      <div class="nav-right">
        <nav class="nav-item level is-mobile">
          
        </nav>
      </div>
    </nav>
  </div>
</section>

<section class="section">
  <div class="container">
    <h1 class="title">ðŸ’» MVCC 101</h1>
    
    
    <h2 class="subtitle is-5">
      August 20, 2023
       by CryptoPatrick
      
        
        <span class="tags-inline" style="margin-left:0.1em;">
          
            
            <a class="tag is-link is-light" href="../../../../../tags/databases/" style="margin-left:0.25em;">databases</a>
          
            
            <a class="tag is-link is-light" href="../../../../../tags/mvcc/" style="margin-left:0.25em;">mvcc</a>
          
            
            <a class="tag is-link is-light" href="../../../../../tags/rust/" style="margin-left:0.25em;">rust</a>
          
        </span>
      
      
    </h2>
    <div class="content">
      <p><a href="https://en.wikipedia.org/wiki/Multiversion_concurrency_control">MVCC</a> stands for MultiVersion Concurrency Control.
It&rsquo;s a way to implement <em>transactional isolation</em> in any application that needs to manage the <em>state</em> of <em>data</em> items.</p>
<p>The traditional mechanism for state management in a database is concurrent control using read-write locks. However, this solution is based on <em>blocking</em> and can create <em>contention</em>.
MVCC is <em>not</em> blocking. This means that multiple clients can read and write simultaneously -  reads do not block other reads and writes do not block other writes or reads.</p>
<h2 id="what-is-isolation">What is Isolation?</h2>
<p>The four cardinal principles of Database transaction are expressed as the accronym <a href="wikipedia/ACID">ACID</a>:</p>
<ul>
<li><strong>Atomicity</strong> : all-or-nothing execution</li>
<li><strong>Consistency</strong> : constraints about acceptable post-transaction states</li>
<li><strong>Isolation</strong> : each transaction must appear to be executed as if no other transaction is executing as the same time</li>
<li><strong>Durability</strong> : the condition that once completed, the effect on the database of a transaction, must never be lost.</li>
</ul>
<p>The principle of <em>Isolation</em> guides our efforts to guarantee that when a database client initiates a transaction, the data that the client sees will always be the same. Regardless of other ongoing transactions, including ones that are modifying database records.</p>
<h3 id="a-small-example">A small example</h3>
<p>Alice works at Transparent Inc., a progressive company that allows its employees to check everyone&rsquo;s yearly bonus via an Internet browser.
When Alice&rsquo;s browser (client) loads the webpage sent from the company&rsquo;s accounting server, she&rsquo;s shocked and disappointed - &ldquo;Where&rsquo;s my freakin&rsquo; bonus?&rdquo;</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">LastUpdated</th>
          <th style="text-align: center">Employee</th>
          <th style="text-align: center">Bonus</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">10:00</td>
          <td style="text-align: center">Alice</td>
          <td style="text-align: center">$0</td>
      </tr>
      <tr>
          <td style="text-align: left">10:00</td>
          <td style="text-align: center">Bob</td>
          <td style="text-align: center">$500</td>
      </tr>
      <tr>
          <td style="text-align: left">10:00</td>
          <td style="text-align: center">David</td>
          <td style="text-align: center">$500</td>
      </tr>
  </tbody>
</table>
<p>Feeling quite upset, Alice calls accounting:<br>
&ldquo;<em>Accounting, you&rsquo;re talking to Mallory. What can I help you with?</em>&rdquo; <br>
&ldquo;<em>It&rsquo;s Alice. I&rsquo;m looking at my bonus for this year, it&rsquo;s $0. What&rsquo;s going on?</em>&rdquo;<br>
&ldquo;<em>I just calculated your bonus and updated it just before you called.</em>&rdquo;<br>
&ldquo;<em>Nope. All I see is $0.</em>&rdquo;<br>
&ldquo;<em>Well, I&rsquo;m looking at your bonus right now and it&rsquo;s not $0.<br>
Have you tried refreshing your browser?</em>&rdquo;.</p>
<p>Still annoyed, Alice clicks the refresh button on her browser. As her browser loads a new <em>version</em> of the page, Alice mood goes from happy to surprised.</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">LastUpdated</th>
          <th style="text-align: center">Employee</th>
          <th style="text-align: center">Bonus</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">10:15</td>
          <td style="text-align: center">Alice</td>
          <td style="text-align: center">$500</td>
      </tr>
      <tr>
          <td style="text-align: left">10:00</td>
          <td style="text-align: center">Bob</td>
          <td style="text-align: center">$500</td>
      </tr>
      <tr>
          <td style="text-align: left">10:15</td>
          <td style="text-align: center">Celine</td>
          <td style="text-align: center">$3000</td>
      </tr>
  </tbody>
</table>
<p>Alice smiles, but then reacts.<br>
&ldquo;<em>Wait! What happened to David&rsquo;s bonus, and who&rsquo;s Celine?</em>&rdquo;<br>
&ldquo;<em>The company CFO just called and instructed me to remove David&rsquo;s bonus. Apparently, David is under police investigation for stealing company secrets.  Celine is the newly applied company Ai. It&rsquo;s been delivering amazing results.</em>&rdquo;</p>
<p>The example illustrates three expected behaviours of the database.<br>
If Mallory at Accounting starts a transaction that:</p>
<ul>
<li><strong>Modifies a record (Alice):</strong> Alice will still see her bonus as being $0, since Mallory&rsquo;s update transaction had not completed by the time Alice&rsquo;s browser sent a request for the page.</li>
<li><strong>Deletes a record (David):</strong> Alice will still see her bonus (until she refreshes her browser)</li>
<li><strong>Adds a record (Celine):</strong> Alice won&rsquo;t see the effects until she refreshes her browser (sending a request for the new version of each record).</li>
</ul>
<blockquote>
<p>There are exception to these rules (skew).</p>
</blockquote>
<hr>
<h2 id="the-read-write-lock-challenge">The Read-Write Lock Challenge:</h2>
<p>In the early days of databases, a common solution to handle concurrent readers and writers was to simply <em>lock the entire database</em> when someone wanted to read or write.</p>
<p>Some of the downsides of <code>Locking</code>:</p>
<ul>
<li>if we lock the whole database then readers and writers have to wait - this creates <em>contention</em>.</li>
<li>if we <em>do not</em> lock the database, and allow writers to write when they want, then readers might get inconsitent data.</li>
<li>our database become more durable if we can easilty abort the process and rollback any changes we intended to make.</li>
</ul>
<h1 id="lets-introduce-some-terminology">Let&rsquo;s introduce some terminology</h1>
<p>There&rsquo;s quite a lot terminology associated with MVCC - we certainly won&rsquo;t have time to explore much of them here. For the interested reader <a href="https://www.amazon.com/Transactional-Information-Systems-Algorithms-Concurrency/dp/1558605088">the book</a> is referenced in the MVCC wiki page.<br>
In this post we&rsquo;ll limit the scope to a few essential concepts that we can use to build rudimentary MVCC mechanisms.</p>
<h2 id="record">Record</h2>
<p>We need a term for the smallest unit of information that the MVCC will handle.
In a traditional <em>relational database</em>, a <code>record</code> in database terms refers to one single cell of data.
In this post we&rsquo;re going to assume that a <code>record</code> refers to a single cell of data in a row in a <code>database</code>.</p>
<p>The fundamental assumption is that a <code>record</code> is discreet and <em>cannot</em> be simultaneously modified by multiple entities/ clients/transactions.</p>
<p>In a graph database we&rsquo;re are going to define a record as a graph element (a node, or an edge).</p>
<h2 id="collection">Collection</h2>
<p>A <code>collection</code> is a <em>set</em> of <code>records</code> that enable us to <em>simultaneoulsy</em> (in one transaction) <em>modify</em> (create, read, update, delete) a <em>group</em> of records.</p>
<p>A single transaction can include multiple collections.  We can think of collection as a table in a database. All <code>records</code> that share the same <code>Transaction Id</code> are also part of the same <code>collection</code>.</p>
<p>The important thing here is that a transaction is not isolated to a single collection as long as each of the records share the same transaction IDs.</p>
<h2 id="transaction-identifier">Transaction Identifier</h2>
<p>Every transaction in the database is given a unique identifier, a <code>transactionId</code>.
The unique identifer could be a number but it doesn&rsquo;t have to be.</p>
<p>A <code>transactionId</code> is the unique number for the transaction.
All records that have been modified under the same transaction can be saved or rolled back as one atomic operation, which is ultimately what we want.</p>
<p>There are multiple ways to identify transactions, here are three popular ways:</p>
<h3 id="1-__incrementing-number__">1. <strong>Incrementing number</strong></h3>
<p>For each new transaction, an atomic counter generates a <code>nonce</code> (number used once), and assigns it as the <code>transactionId</code>. This happens <em>before</em> any changes to the collection of records occur.</p>
<p>The <code>transactionId</code> represent <strong>all</strong> the record changes. Regardless if the record changes are committed or discarded, a nonce can only be used once for the same <code>transactionId</code>.</p>
<p>For in-memory mvcc, all transactionIds must be persisted to avoid collisions from a nonce being used more than once if the application needs to be restarted.</p>
<h3 id="2--__timestamp__">2.  <strong>Timestamp</strong></h3>
<p>Each <code>transactionId</code> is assigned a <em>high granularity</em> <code>timestamp</code>. In order to avoid a a collision (two transactions with the same timestamp), the granularity needs to reflect the probability of two transactions being spawned close in time.</p>
<p>Timestamps enable the database system to <em>recreate</em> or <em>restore</em> the exact state of the collections to some point in time.</p>
<h3 id="3--__uuid-universal-unique-id__">3.  <strong>UUID, Universal Unique ID</strong></h3>
<p>UUID is a popular way to assign unique identifiers. It should be noted that UUID does theoretically include the risk of collisions, even though the risk is extremely small.
is note Special cases where you are working with distributed databases or have other requirements that are not satisfied by the two types above. This may include UUID based algorithms and may not even be strictly a number.</p>
<blockquote>
<p>In this post we&rsquo;ll implement <code>TransactionId</code> useing an <code>incrementing counter</code>.</p>
</blockquote>
<hr>
<h1 id="mvcc-api">MVCC API</h1>
<p>With the bare fundamentals in place we are now ready to start building a simple MVCC API.
The <strong>interface</strong> that we want our API to provide is the following:</p>
<ul>
<li>Initiate a Transaction payload ?</li>
<li>Creating a record</li>
<li>Update a record</li>
<li>Delete a record</li>
<li>Commit Transaction Payload (changes)</li>
<li>Rollback changes</li>
</ul>
<blockquote>
<p>Our intention is to use Rust&rsquo;s powerful type system to create a generic MVCC protocol.</p>
</blockquote>
<p>In order to produce new transactions we need:</p>
<ul>
<li>the next <code>transactionId</code> (idea: use std::iter::Successor trait?)</li>
</ul>
<ul>
<li>an array or set (HashSet?) of the current active transaction</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">// We initialize a varible that will be responsible for holding the next 
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// available  transaction id number.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// Being treated like a global variable - TODO: find a better solution.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// TODO: look at using UUID
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#434f54">let</span> <span style="color:#434f54">mut</span> <span style="color:#434f54">next_xid</span><span style="color:#728e00">:</span><span style="color:#00979d">u32</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">1</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">// We use a vector to hold the list of currently active transaction Ids.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// TODO: change to HashSet?
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// TODO: change the type to one that ONLY takes TxId
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// We use a BTreeSet to track the order of when a TxId is added
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// According to data structure convention, it is a logic error for an item in a BTreeSet
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// to be modified in such a way that the itemâ€™s ordering relative to any other item 
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// as determined by the Ord trait, changes while it is in the set.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// Sounds perfect, let&#39;s use that.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// TODO: We can also require elements to be of TxId type.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#434f54">let</span> <span style="color:#434f54">mut</span> <span style="color:#434f54">active_xids</span><span style="color:#728e00">:</span><span style="color:#00979d">BTreeSet&lt;u32&gt;</span> <span style="color:#728e00">=</span> <span style="color:#434f54">BTreeSet</span><span style="color:#728e00">:</span><span style="color:#00979d">:new</span><span style="color:#728e00">();</span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">// We initialize an empty vector that we&#39;ll use to hold records that we want to 
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// include in a transaction.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#434f54">let</span> <span style="color:#434f54">records</span><span style="color:#728e00">:</span> <span style="color:#00979d">BTreeMap&lt;String</span><span style="color:#728e00">,</span> <span style="color:#434f54">u32</span><span style="color:#728e00">&gt;</span> <span style="color:#728e00">=</span> <span style="color:#434f54">BTreeMap</span><span style="color:#728e00">:</span><span style="color:#00979d">:new</span><span style="color:#728e00">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#95a5a6">// new transaction will take next_xid by reference.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#434f54">fn</span> <span style="color:#434f54">new_transaction</span><span style="color:#728e00">(</span><span style="color:#434f54">next_xid</span><span style="color:#728e00">:</span> <span style="color:#00979d">&amp;mut</span> <span style="color:#00979d">u32</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">Result</span><span style="color:#728e00">&lt;</span><span style="color:#434f54">Transaction</span><span style="color:#728e00">,</span> <span style="color:#434f54">Err</span><span style="color:#728e00">&gt;</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// We prime the next transaction payload by incrementing the atomic counter 
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// that is in charge of issuing transaction Ids.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">next_xid</span> <span style="color:#728e00">=</span> <span style="color:#434f54">next_xid</span> <span style="color:#728e00">+</span> <span style="color:#8a7b52">1</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Our newly minted transaction is added to the list of active transactions.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// TODO: remove ops: *.contains(X), *.remove(X)
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">active_xids</span><span style="color:#728e00">.</span><span style="color:#434f54">insert</span><span style="color:#728e00">(</span><span style="color:#434f54">next_xid</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// Construct and return a new Transaction.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// If Transaction::new() fails then we bubble up the error.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">Ok</span><span style="color:#728e00">(</span><span style="color:#434f54">Transaction</span><span style="color:#728e00">:</span><span style="color:#00979d">:new</span><span style="color:#728e00">()</span><span style="color:#00979d">.set_txid</span><span style="color:#728e00">(</span><span style="color:#00979d">next_xid</span><span style="color:#728e00">)</span><span style="color:#00979d">?</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#95a5a6">/// Transaction is a builder responsible for creating transactions.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">/// We can use to add records that are to be included in the transation.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">/// Example
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">/// ```
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">/// let mut phonebook:HashMap&lt;String, u8&gt; = vec!({&#34;Alice&#34;:123}, {&#34;Bob&#34;:555});
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">/// // The Conductor is in charge of handling all transactions according to MVCC.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">/// let c = Conductor::new(phonebook);
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">/// let mut t: Transaction = Transaction::new().set_txid(1);
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">/// t1.add_record({&#34;Alice&#34;:321});
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">/// // The Conductor registers the commited transaction, making sure that it gets
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">/// // persisted to disk, and also marks older versions of a record for deletion.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">/// c.register(t.commit());
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#434f54">struct</span> <span style="color:#434f54">Transaction</span><span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// The unique id of the transaction.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">xid</span><span style="color:#728e00">:</span><span style="color:#00979d">u32</span><span style="color:#728e00">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">//TODO: look at the time of this vec, should it be Vec&lt;u32&gt;?
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// A list of things that need to be undone
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// in the event that the transaction is rolled back
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// (meaning, it will be reverted/_not_ committed).
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// needs to be ordered, changeable.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// TODO: should it allow duplicate members?
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// TODO: decide on type here!
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// We use a BTreeSet because we need to store
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// in order.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// In the BTreeSet we (orderly) store HashMaps
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// because we need keys associated with values
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// Like, TransactionType::Add(&#34;add&#34;) = 1
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// TODO: probably should change String into an
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// enum.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">rollback_actions</span><span style="color:#728e00">:</span> <span style="color:#00979d">BTreeSet&lt;BTreeMap&lt;String</span><span style="color:#728e00">,</span> <span style="color:#434f54">u32</span><span style="color:#728e00">&gt;&gt;,</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">impl</span> <span style="color:#434f54">Transaction</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">pub</span> <span style="color:#434f54">fn</span> <span style="color:#728e00">new</span><span style="color:#728e00">(&amp;</span><span style="color:#434f54">self</span><span style="color:#728e00">,</span> <span style="color:#434f54">xid</span><span style="color:#728e00">:</span><span style="color:#00979d">u32</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">Self</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">Transaction</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">xid</span> <span style="color:#728e00">=</span> <span style="color:#434f54">xid</span><span style="color:#728e00">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><p>For each <code>record</code> we want to be able to <em>track</em> two pieces of <em>metadata</em>, that represent a <code>TransactionId</code>, but they are not <em>required</em> to have values:</p>
<ul>
<li><code>created XID</code></li>
<li><code>expired XID</code></li>
</ul>
<p>If possible, we want to store these two as fields of the <code>record</code> type. Could be stored outside of
memory.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#434f54">struct</span> <span style="color:#434f54">Record</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">created_xid</span><span style="color:#728e00">:</span> <span style="color:#00979d">Option&lt;u32&gt;</span><span style="color:#728e00">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">expired_xid</span><span style="color:#728e00">:</span> <span style="color:#00979d">Option&lt;u32&gt;</span><span style="color:#728e00">,</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><h2 id="record-visibility-and-locking">Record Visibility and Locking</h2>
<blockquote>
<p>The visibility of a row depends on who is looking at it.</p>
</blockquote>
<blockquote>
<p>Every row has to be tested if it is visible from the point of view of the transaction looking at it:</p>
</blockquote>
<p>A transaction, $T_i$, is only allowed to <code>read</code> or <code>mutate</code> any <code>record</code> $R_j$ that is <strong>visible</strong> to the transaction.
So, we have to <strong>test</strong> the <em>visibility</em> of each <code>record</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#95a5a6">// We need to check if the record, that was passed to the function, is already 
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// included in some other active/ongoing transaction, and if that active/ongoing
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// transaction is the instance of Transaction to which record_is_viisible belongs
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// or if that ongoing transaction is an other instance of Transaction.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// TODO: check type for record here 
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#434f54">impl</span> <span style="color:#434f54">Transaction</span><span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">fn</span> <span style="color:#434f54">record_is_visible</span><span style="color:#728e00">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">&amp;</span><span style="color:#434f54">self</span><span style="color:#728e00">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">active_xids</span><span style="color:#728e00">:</span> <span style="color:#00979d">&amp;BTreeSet&lt;u32&gt;</span><span style="color:#728e00">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">record</span><span style="color:#728e00">:</span> <span style="color:#00979d">&amp;BTreeMap&lt;String</span><span style="color:#728e00">,</span> <span style="color:#434f54">u32</span><span style="color:#728e00">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">bool</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Case: The record was created in an other currently active transaction
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// so the record is _not_ an element of this transaction&#39;s group of records.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// if active_xids.contains(record.get(&amp;&#34;created_xid&#34;)) &amp;&amp; record.get(&amp;&#34;created_xid&#34;) != self.xid {
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// If the xid is active but it does not belong
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// to this Transaction we return false.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">if</span> <span style="color:#434f54">active_xids</span><span style="color:#728e00">.</span><span style="color:#434f54">contains</span><span style="color:#728e00">(</span><span style="color:#434f54">record</span><span style="color:#728e00">.</span><span style="color:#434f54">get</span><span style="color:#728e00">(&amp;</span><span style="color:#7f8c8d">&#34;created_xid&#34;</span><span style="color:#728e00">))</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">if</span> <span style="color:#434f54">record</span><span style="color:#728e00">.</span><span style="color:#434f54">get</span><span style="color:#728e00">(&amp;</span><span style="color:#7f8c8d">&#34;created_xid&#34;</span><span style="color:#728e00">)</span> <span style="color:#728e00">!=</span> <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">xid</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#728e00">return</span> <span style="color:#00979d">false</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Case: The record expired or an no transactions holds it that is our own
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">if</span> <span style="color:#434f54">record</span><span style="color:#728e00">.</span><span style="color:#434f54">get</span><span style="color:#728e00">(&amp;</span><span style="color:#7f8c8d">&#34;expired_xid&#34;</span><span style="color:#728e00">)</span> <span style="color:#728e00">!=</span> <span style="color:#8a7b52">0</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#95a5a6">// if !active_xids.contains(record.get(&amp;&#34;expired_xid&#34;)) || record.get(&amp;&#34;created_xid&#34;) == self.xid {
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>            <span style="color:#728e00">if</span> <span style="color:#434f54">active_xids</span><span style="color:#728e00">.</span><span style="color:#434f54">contains</span><span style="color:#728e00">(</span><span style="color:#434f54">record</span><span style="color:#728e00">.</span><span style="color:#434f54">get</span><span style="color:#728e00">(&amp;</span><span style="color:#7f8c8d">&#34;expired_xid&#34;</span><span style="color:#728e00">))</span> <span style="color:#728e00">==</span> <span style="color:#00979d">false</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#728e00">return</span> <span style="color:#00979d">false</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">}</span> <span style="color:#728e00">else</span> <span style="color:#728e00">if</span> <span style="color:#434f54">record</span><span style="color:#728e00">.</span><span style="color:#434f54">get</span><span style="color:#728e00">(&amp;</span><span style="color:#7f8c8d">&#34;created_xid&#34;</span><span style="color:#728e00">)</span> <span style="color:#728e00">==</span> <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">xid</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#728e00">return</span> <span style="color:#00979d">false</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Our checks above indicate that the record is visible to our Transaction.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// So we can return true.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#00979d">true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><h2 id="collision">Collision</h2>
<p>Simultaneous transactions cannot make a modification to the same record.
There are two strategies we can use to handle
conflicts
// If this happens there are two ways to handle this:</p>
<ol>
<li><strong>Rollback</strong><br>
We abort and rollback the transaction that tried to make the most recent change(s) (the tx with the most recent timestamp or highest xid counter value).<br>
We can also propagate the error back to the original client.</li>
<li><strong>Blocking</strong><br>
We await (block) the second transaction until the record that the transaction wants to modify becomes available.<br>
This strategy has performance challenges and potential reread errors.</li>
</ol>
<p>Rollback strategy is the safest one, so let&rsquo;s use that.</p>
<p>// TODO: why is this step necessary?</p>
<h3 id="is-the-row-locked">Is the Row Locked?</h3>
<p>When we do need to modify a record we need to check if itâ€™s locked by another transaction with this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#95a5a6">// TODO: Should the record be a BTreeMap&lt;String, u32&gt;?
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#434f54">impl</span> <span style="color:#434f54">Transaction</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">fn</span> <span style="color:#434f54">row_is_locked</span><span style="color:#728e00">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">&amp;</span><span style="color:#434f54">self</span><span style="color:#728e00">,</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">record</span><span style="color:#728e00">:</span> <span style="color:#00979d">&amp;HashMap&lt;String</span><span style="color:#728e00">,</span> <span style="color:#434f54">u32</span><span style="color:#728e00">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">bool</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#728e00">if</span> <span style="color:#434f54">record</span><span style="color:#728e00">.</span><span style="color:#434f54">get</span><span style="color:#728e00">(&amp;</span><span style="color:#7f8c8d">&#34;expired_xid&#34;</span><span style="color:#728e00">)</span> <span style="color:#728e00">!=</span> <span style="color:#8a7b52">0</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#95a5a6">// if !active_xids.contains(record.get(&amp;&#34;expired_xid&#34;)) || record.get(&amp;&#34;created_xid&#34;) == self.xid {
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>            <span style="color:#728e00">if</span> <span style="color:#434f54">active_xids</span><span style="color:#728e00">.</span><span style="color:#434f54">contains</span><span style="color:#728e00">(</span><span style="color:#434f54">record</span><span style="color:#728e00">.</span><span style="color:#434f54">get</span><span style="color:#728e00">(&amp;</span><span style="color:#7f8c8d">&#34;expired_xid&#34;</span><span style="color:#728e00">))</span> <span style="color:#728e00">==</span> <span style="color:#00979d">true</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#728e00">return</span> <span style="color:#00979d">true</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">}</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">return</span> <span style="color:#00979d">false</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">}</span> <span style="color:#728e00">else</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">return</span> <span style="color:#00979d">false</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><h1 id="crud-time">CRUD Time!</h1>
<h2 id="adding-a-record">Adding a Record</h2>
<p>// TODO: why?
We set the <code>created_xid</code> to the current <code>transactionId</code> and <code>expired_xid</code> to 0:
So the record gets stamped with an id indicating
which <code>TransactionId</code> that it got included into.
We also set the expiration date of the record to 0.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#434f54">impl</span> <span style="color:#434f54">Transaction</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// The record&#39;s attribute _created_xid_ gets the TransactionId value of the Transaction that included it in its collection of records that its handling. 
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// TODO: change &#34;created_xid&#34; into an enum
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// Record::{TransactionCreattionId, TransactionExpirationId}
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// record.get()
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">fn</span> <span style="color:#434f54">add_record</span><span style="color:#728e00">(&amp;</span><span style="color:#434f54">self</span><span style="color:#728e00">,</span> <span style="color:#728e00">&amp;</span><span style="color:#434f54">mut</span> <span style="color:#434f54">record</span><span style="color:#728e00">:</span> <span style="color:#00979d">&amp;mut</span> <span style="color:#00979d">HashMap&lt;String</span><span style="color:#728e00">,</span> <span style="color:#434f54">u32</span><span style="color:#728e00">&gt;</span> <span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">Result</span><span style="color:#728e00">&lt;(),</span> <span style="color:#434f54">Err</span><span style="color:#728e00">&gt;</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">record</span><span style="color:#728e00">[</span><span style="color:#a61717">&#34;</span><span style="color:#00979d">created_xid</span><span style="color:#a61717">&#34;</span><span style="color:#728e00">]</span> <span style="color:#728e00">=</span> <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">xid</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">record</span><span style="color:#728e00">[</span><span style="color:#a61717">&#34;</span><span style="color:#00979d">expired_xid</span><span style="color:#a61717">&#34;</span><span style="color:#728e00">]</span> <span style="color:#728e00">=</span> <span style="color:#8a7b52">0</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// rollback_actions: BTreeSet&lt;BTreeMap&lt;String, u32&gt;&gt;,
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// Unclear if this should be:
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// .insert or .append ... append adds the element to the end of the list
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// insert adds the element to the specific position.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// We insert a &#34;delete&#34; operation at the correct index of the rollback set
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// If we decide to rollback then the rollback function well see that a &#34;delete&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#95a5a6">// action was queued at this sequence slot of the transaction.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#434f54">let</span> <span style="color:#434f54">mut</span> <span style="color:#434f54">action</span><span style="color:#728e00">:</span><span style="color:#00979d">BTreeMap&lt;String</span><span style="color:#728e00">,</span> <span style="color:#434f54">u32</span><span style="color:#728e00">&gt;</span> <span style="color:#728e00">=</span> <span style="color:#434f54">BTreeMap</span><span style="color:#728e00">:</span><span style="color:#00979d">:new</span><span style="color:#728e00">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">action</span><span style="color:#728e00">.</span><span style="color:#434f54">insert</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;delete&#34;</span><span style="color:#728e00">.</span><span style="color:#434f54">to_string</span><span style="color:#728e00">(),</span> <span style="color:#434f54">records</span><span style="color:#728e00">.</span><span style="color:#434f54">len</span><span style="color:#728e00">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">rollback_actions</span><span style="color:#728e00">.</span><span style="color:#434f54">insert</span><span style="color:#728e00">(</span><span style="color:#434f54">action</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">Ok</span><span style="color:#728e00">(</span><span style="color:#434f54">records</span><span style="color:#728e00">.</span><span style="color:#434f54">append</span><span style="color:#728e00">(</span><span style="color:#434f54">record</span><span style="color:#728e00">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><h2 id="deleting-a-record">Deleting a Record</h2>
<p>/////////////////////////////////////////////
In deleting a <code>record</code>, we need to handle two different scenarios:</p>
<ul>
<li>
<ol>
<li>The record has an <code>expired_xid</code> or $0$.<br>
That would indicate that the record has never been deleted - not but the TransactionId that is checking, not by any other transaction.
Changing the <code>expired_xid</code> to the <code>TransactionId</code> would <strong>mark</strong> the <code>record</code> as being <strong>eligable</strong> up for deletion (by a vacuum procees or something similar, see below.)</li>
</ol>
</li>
<li>
<ol start="2">
<li>If the <code>expired_xid</code> != $0$ then <code>expired_xid</code> is an active transaction.
That would indicate that the <code>record</code> has been deleted by another active transaction.
In that case we can&rsquo;t modify the <code>record</code> in any way - it&rsquo;s locked.</li>
</ol>
</li>
</ul>
<blockquote>
<p>Due to visibility constraints, <code>expired_xid</code> has to be an active transaction.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#95a5a6">// We pass the identifier of the record we
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// want to delete.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6">// We also need to pass, by reference, our records store.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span><span style="color:#434f54">impl</span> <span style="color:#434f54">Transactions</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">fn</span> <span style="color:#434f54">delete_record</span><span style="color:#728e00">(&amp;</span><span style="color:#434f54">self</span><span style="color:#728e00">,</span> <span style="color:#434f54">id</span><span style="color:#728e00">:</span><span style="color:#00979d">u32</span><span style="color:#728e00">,</span> <span style="color:#728e00">&amp;</span><span style="color:#434f54">records</span><span style="color:#728e00">:</span><span style="color:#00979d">HashMap&lt;String</span><span style="color:#728e00">,</span><span style="color:#434f54">u32</span><span style="color:#728e00">&gt;)</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">Result</span><span style="color:#728e00">&lt;(),</span> <span style="color:#434f54">Err</span><span style="color:#728e00">&gt;</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// We iterate over each record in our record store, and check if the id of that particular stored record matches the id of the record that we want to delete.   
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#728e00">for</span> <span style="color:#728e00">(</span><span style="color:#434f54">i</span><span style="color:#728e00">,</span><span style="color:#434f54">record</span><span style="color:#728e00">)</span> <span style="color:#434f54">in</span> <span style="color:#434f54">records</span><span style="color:#728e00">.</span><span style="color:#434f54">iter</span><span style="color:#728e00">().</span><span style="color:#434f54">enumerate</span><span style="color:#728e00">()</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">if</span> <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">record_is_visible</span><span style="color:#728e00">(&amp;</span><span style="color:#434f54">record</span><span style="color:#728e00">)</span> <span style="color:#728e00">&amp;&amp;</span> <span style="color:#434f54">record</span><span style="color:#728e00">.</span><span style="color:#434f54">get</span><span style="color:#728e00">(&amp;</span><span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">).</span><span style="color:#434f54">unwrap</span><span style="color:#728e00">()</span> <span style="color:#728e00">==</span> <span style="color:#728e00">&amp;</span><span style="color:#434f54">id</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#728e00">if</span> <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">row_is_locked</span><span style="color:#728e00">(&amp;</span><span style="color:#434f54">record</span><span style="color:#728e00">)</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#728e00">return</span> <span style="color:#434f54">Err</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;Row is locked by another transaction&#34;</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#728e00">}</span> <span style="color:#728e00">else</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#434f54">record</span><span style="color:#728e00">[</span><span style="color:#a61717">&#34;</span><span style="color:#00979d">expired_xid</span><span style="color:#a61717">&#34;</span><span style="color:#728e00">]</span> <span style="color:#728e00">=</span> <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">xid</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#434f54">let</span> <span style="color:#434f54">new_rec</span><span style="color:#728e00">:</span> <span style="color:#00979d">HashMap&lt;String</span><span style="color:#728e00">,</span><span style="color:#434f54">u32</span><span style="color:#728e00">&gt;</span> <span style="color:#728e00">=</span> <span style="color:#434f54">HashMap</span><span style="color:#728e00">:</span><span style="color:#00979d">:new</span><span style="color:#728e00">();</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#434f54">new_rec</span><span style="color:#728e00">[</span><span style="color:#a61717">&#34;</span><span style="color:#00979d">add</span><span style="color:#a61717">&#34;</span><span style="color:#728e00">]</span> <span style="color:#728e00">=</span> <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">xid</span><span style="color:#728e00">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">rollback_actions</span><span style="color:#728e00">.</span><span style="color:#434f54">append</span><span style="color:#728e00">(</span><span style="color:#434f54">new_rec</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#95a5a6">// TODO: Should this really return ok?
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>                    <span style="color:#728e00">return</span> <span style="color:#434f54">Ok</span><span style="color:#728e00">(())</span>
</span></span><span style="display:flex;"><span>                <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><h2 id="updating-a-record">Updating a Record</h2>
<p>To modify a specific <code>record</code> we <strong>delete</strong> the older version of the <code>record</code>, and <strong>add</strong> a new version of the <code>record</code>.
The existig <code>record</code> will still be visible by other <code>transactions</code>.</p>
<p>// TODO: verify logic of block from failed update.
If the call to <code>fn update_record()</code> fails then
its error will bubble upstream and block the subsequent call to <code>fn add_record</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#434f54">fn</span> <span style="color:#434f54">update_record</span><span style="color:#728e00">(&amp;</span><span style="color:#434f54">self</span><span style="color:#728e00">,</span> <span style="color:#434f54">id</span><span style="color:#728e00">:</span><span style="color:#00979d">u32</span><span style="color:#728e00">,</span> <span style="color:#434f54">name</span><span style="color:#728e00">:</span><span style="color:#00979d">String</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">Result</span><span style="color:#728e00">&lt;(),</span> <span style="color:#434f54">Err</span><span style="color:#728e00">&gt;</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">delete_record</span><span style="color:#728e00">(</span><span style="color:#434f54">id</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">let</span> <span style="color:#434f54">new_record_version</span><span style="color:#728e00">:</span><span style="color:#00979d">HashMap&lt;String</span><span style="color:#728e00">,</span><span style="color:#434f54">u32</span><span style="color:#728e00">&gt;</span> <span style="color:#728e00">=</span> <span style="color:#434f54">HashMap</span><span style="color:#728e00">:</span><span style="color:#00979d">:new</span><span style="color:#728e00">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">new_record_version</span><span style="color:#728e00">.</span><span style="color:#434f54">insert</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;id&#34;</span><span style="color:#728e00">,</span> <span style="color:#434f54">id</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">new_record_version</span><span style="color:#728e00">.</span><span style="color:#434f54">insert</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;name&#34;</span><span style="color:#728e00">,</span> <span style="color:#434f54">name</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">add_record</span><span style="color:#728e00">(</span><span style="color:#434f54">new_record_version</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><h2 id="commit-changes">Commit Changes</h2>
<p>Once all the modifications have been made we need to commit all the changes so that future clients/transactions can see these new changes.</p>
<p>Once all the modifications to the <code>records</code> have been made it&rsquo;s time to m commit the changes.
Once the changes have been commmited, other <code>transactionId</code> will be able to see the changes.
Clientes, like Alice browser in the earlier example will be able to see the changes
once the web page has been reloaded.</p>
<p>completedthe <code>TransactionId</code> has completed all its work (things like update, reading,
deleting records), it&rsquo;s time commit the changes.<br>
We do this by <em>removing</em> the <code>TransactionId</code>, from <code>active_xid</code> (the list of active transactions).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#434f54">impl</span> <span style="color:#434f54">Transaction</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// We remove our TransactionId from the list of
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// active transactions.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// TODO: Improve error handling here.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">fn</span> <span style="color:#434f54">commit</span><span style="color:#728e00">(&amp;</span><span style="color:#434f54">self</span><span style="color:#728e00">,</span> <span style="color:#728e00">&amp;</span><span style="color:#434f54">mut</span> <span style="color:#434f54">active_xids</span><span style="color:#728e00">)</span> <span style="color:#728e00">-&gt;</span> <span style="color:#434f54">Result</span><span style="color:#728e00">&lt;(),</span> <span style="color:#434f54">bool</span><span style="color:#728e00">&gt;</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#434f54">active_xids</span><span style="color:#728e00">.</span><span style="color:#434f54">remove</span><span style="color:#728e00">(&amp;</span><span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">xid</span><span style="color:#728e00">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><blockquote>
<p>The time complexity of `fn commit() is $O(n)$ so long running transactions with a large number of changes should be no problem.</p>
</blockquote>
<h2 id="rollback-changes">Rollback Changes</h2>
<p>If for some reason we have to <em>abort</em> the <em>transaction</em> then we can do so in
multiple ways. Rollback means performing the modifications the transaction did, but in revers.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scala" data-lang="scala"><span style="display:flex;"><span><span style="color:#434f54">enum</span> <span style="color:#434f54">TransactionTypes</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Add</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;add&#34;</span><span style="color:#728e00">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#434f54">Delete</span><span style="color:#728e00">(</span><span style="color:#7f8c8d">&#34;delete&#34;</span><span style="color:#728e00">),</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#434f54">impl</span> <span style="color:#434f54">Transaction</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#95a5a6">// In order to walk back our intended modifications we iterate over rollback_actions in reverse.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// first element is the action &#34;add&#34;, &#34;delete&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// second element is the index of the record in question.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#95a5a6">// records is a BTreeMap&lt;String, u32&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>    <span style="color:#434f54">fn</span> <span style="color:#434f54">rollback</span><span style="color:#728e00">(&amp;</span><span style="color:#434f54">self</span><span style="color:#728e00">,</span> <span style="color:#728e00">&amp;</span><span style="color:#434f54">mut</span> <span style="color:#434f54">records</span><span style="color:#728e00">)</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">for</span> <span style="color:#434f54">action</span> <span style="color:#434f54">in</span> <span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">rollback_actions</span><span style="color:#728e00">.</span><span style="color:#434f54">iter</span><span style="color:#728e00">().</span><span style="color:#434f54">rev</span><span style="color:#728e00">()</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#95a5a6">// Each action that we get is a HashMap containing the action type
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>            <span style="color:#728e00">if</span> <span style="color:#434f54">let</span> <span style="color:#434f54">Some</span><span style="color:#728e00">((</span><span style="color:#434f54">key</span><span style="color:#728e00">,</span> <span style="color:#434f54">value</span><span style="color:#728e00">))</span> <span style="color:#728e00">=</span> <span style="color:#434f54">action</span><span style="color:#728e00">.</span><span style="color:#434f54">first_key_value</span><span style="color:#728e00">()</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#728e00">match</span> <span style="color:#434f54">key</span><span style="color:#728e00">.</span><span style="color:#434f54">as_str</span><span style="color:#728e00">()</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f8c8d">&#34;add&#34;</span> <span style="color:#728e00">=&gt;</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#95a5a6">// Our action previously added the record to our `TransactionId`,
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>                        <span style="color:#95a5a6">// so now we rollback by removing it from our `TransactionId`.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>                        <span style="color:#95a5a6">// By setting the expired_xid attribute of the record in question to 0
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>                        <span style="color:#95a5a6">// we state that the record is no longer an element of an expired `TransactionId`.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>                        <span style="color:#95a5a6">// TODO: implement removal logic
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>                    <span style="color:#728e00">},</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#7f8c8d">&#34;delete&#34;</span> <span style="color:#728e00">=&gt;</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#95a5a6">// Restore the deleted record
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>                        <span style="color:#95a5a6">// TODO: implement restoration logic
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>                    <span style="color:#728e00">},</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#728e00">_</span> <span style="color:#728e00">=&gt;</span> <span style="color:#728e00">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#95a5a6">// Unknown action type
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>                    <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#95a5a6">// Finally the TransactionId is set as being _inactive_ by removing it from the list of _active transactions.
</span></span></span><span style="display:flex;"><span><span style="color:#95a5a6"></span>        <span style="color:#434f54">active_xids</span><span style="color:#728e00">.</span><span style="color:#434f54">remove</span><span style="color:#728e00">(&amp;</span><span style="color:#434f54">self</span><span style="color:#728e00">.</span><span style="color:#434f54">xid</span><span style="color:#728e00">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#728e00">}</span>
</span></span><span style="display:flex;"><span><span style="color:#728e00">}</span>
</span></span></code></pre></div><h2 id="recovery">Recovery</h2>
<p>Our <code>fn rollback</code> is dependent on two assumptions:</p>
<ul>
<li>
<ol>
<li>In case of an application crash, any transactions that were in the process of being rolled back will continue to finalize that process once the application is restarted.
Otherwise we would get a corrupt db.
One strategy to mitigate this risk is to continuously persist ongoing TransactionIds to disk
and then use that persisted data during application bootup to return the application to its correct state.</li>
</ol>
</li>
<li>
<ol start="2">
<li>We need to verify somehow that all modifications <strong>actually</strong> were rolled back.
The application needs an efficient way to do this.</li>
</ol>
</li>
</ul>
<h2 id="vacuuming-or-reclaiming-space">Vacuuming or Reclaiming Space</h2>
<p>Since we are not actually deleting data, only
marking some data for deletion, with time our in-memory database will grow to be very large.</p>
<p>We need to periodically purge <code>dead transactions</code>
by going through all records and delete the ones that are <em>dead</em>, in order to reclaim <em>space in memory</em>.</p>
<blockquote>
<p>How do we distinguish between alive and dead records?</p>
</blockquote>
<blockquote>
<p>TODO: clarify rows or records below.</p>
</blockquote>
<p>We can simply write all <em>alive</em> rows/records to a new file, drop all the rest from memory, and then read in the records from the file.</p>
<h2 id="death-row">Death Row</h2>
<p>Regarding <em>row visibility</em>:
Records that have an expired_xid != 0, and do not
appear in the <em>active_xids</em>, are to be considered
dead rows and should not appear when <code>fn row_is_visible()</code> is called.</p>




    </div>
    
    
  </div>
</section>

<section class="section">
  <div class="container has-text-centered">
    <p>'I write to understand as much as to be understood.' â€”Elie Wiesel<br> (c) 2024 CryptoPatrick</p>
  </div>
</section>

<script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@10.2.0/build/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>




</body>
