<!DOCTYPE html>
<html>
  <head>
    <title>4-bit angle modulating 16 LEDs using Arduino and shift registers ~ Tiemen</title><meta name="viewport" content="width=device-width, initial-scale=1.0" /> <link
rel="stylesheet" href="/css/main.css" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon.svg" />


<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=UA-25416548-1"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());

  gtag("config", "UA-25416548-1");
</script>
<meta property="og:title" content="4-bit angle modulating 16 LEDs using Arduino and shift registers ~ Tiemen" />
    <meta name="twitter:title" content="4-bit angle modulating 16 LEDs using Arduino and shift registers ~ Tiemen" />
    <meta itemprop="name" content="4-bit angle modulating 16 LEDs using Arduino and shift registers ~ Tiemen" />
    <meta name="application-name" content="4-bit angle modulating 16 LEDs using Arduino and shift registers ~ Tiemen" />
    <meta property="og:site_name" content="" />

    <meta name="keywords" content="" />

    <meta name="description" content="Understanding 4-bit angle modulation, pwm and driving 1 LEDs using an Arduino" />
    <meta itemprop="description" content="Understanding 4-bit angle modulation, pwm and driving 1 LEDs using an Arduino" />
    <meta property="og:description" content="Understanding 4-bit angle modulation, pwm and driving 1 LEDs using an Arduino" />
    <meta name="twitter:description" content="Understanding 4-bit angle modulation, pwm and driving 1 LEDs using an Arduino" />

    <link rel="canonical" href="https://tiemenwaterreus.com/posts/4-bit-angle-modulating/" itemprop="url" />
    <meta name="url" content="https://tiemenwaterreus.com/posts/4-bit-angle-modulating/" />
    <meta name="twitter:url" content="https://tiemenwaterreus.com/posts/4-bit-angle-modulating/" />
    <meta property="og:url" content="https://tiemenwaterreus.com/posts/4-bit-angle-modulating/" />
  </head>
  <body>
    <section class="single-post">
      <section class="post-pre-header">
        <a href="/posts" class="bring-me-back">&larr; all posts</a>

        <div class="meta">
          Posted on May 9, 2015
        </div>
      </section>

      <h1>4-bit angle modulating 16 LEDs using Arduino and shift registers</h1>
      <p>So in this article we’re extending the previous example where we learned how to drive 16 LEDs using three pins of the Arduino. This time we’re taking it to the next level and learn how we can apply fading effects to individual LEDs by using Bit Angle Modulation.</p>
<h2 id="pulse-width-modulation">Pulse Width Modulation</h2>
<p>Bit Angle Modulation or BAM is very similar to Pulse Width Modulation (PWM) which is supported on the Arduino by default by using the PWM pins, which are marked with a tilde (~). PWM allows you to just <code>analogWrite();</code> a value ranging from 0 to 255 to the specified pin, and Arduino will take care of the rest. If you connect a volt-meter to the output pin you would see a voltage between 0V and 5V.</p>
<p>PWM actually applies a squarewave to the pin where it switches from 5V (high) to 0V (low) and back, very rapidly. The period where the pin is high in relation to the total time of one cycle, is called the duty cycle. The duty cycle is at the core of PWM and is being used to control the exact overall voltage of the pin.</p>
<figure><img src="/resources/4-bit-bam/pwm.gif"
         alt="Explaination of PWM on arcuino.cc"/><figcaption>
            <p>Explaination of PWM on arcuino.cc</p>
        </figcaption>
</figure>

<p>As the image above shows us; a 0% duty cycle means that the pin is low for the full cycle, whereas a 100% duty cycle means the pin is high for the full cycle, no rocket science there. It is only where the duty cycle ranges between 0% and 100%, it is starting to get interesting.</p>
<p>A duty cycle of 50% means that the pin is high only for the first half of the cycle, and then low for the remainder of the cycle, only to start over again at the beginning of the new cycle.</p>
<p>If we connect a LED to the pin, it actually starts to flicker since it lights up when the pin is high and turns on when the pin is low. The key to this is to do it so fast that it isn’t distinguishable by the human eye, instead we’ll see a dimmer LED.</p>
<h2 id="how-is-bit-angle-modulation-different">How is Bit Angle Modulation different?</h2>
<p>Ok, so by now we know that the brightness of a LED can be controlled by switching it on and off very rapidly. In the part above we’ve read about how this is actually done using PWM, but Bit Angle Modulation or BAM is just another method to achieve the same thing.</p>
<p>The key difference between PWM and BAM is in how the high versus low periods are calculated. Bit Angle Modulation is also referred to as Binary Code Modulation and as the name suggest; we need to start thinking in binary. BAM uses the key property of binary numbers where as you count upwards, the value of the bits doubles in value. So the least significant bit is 1 and the most significant bit (in a 4-bit system) is 8.</p>
<figure><img src="/resources/4-bit-bam/bam.png"
         alt="https://www.batsocks.co.uk/readme/art_bcm_3.htm"/><figcaption>
            <p><a href="https://www.batsocks.co.uk/readme/art_bcm_3.htm">https://www.batsocks.co.uk/readme/art_bcm_3.htm</a></p>
        </figcaption>
</figure>

<p>This article on <a href="https://www.batsocks.co.uk/readme/art_bcm_3.htm">batsocks.co.uk</a> gave me a clear understanding of how this would actually apply to modulation: The first bit in the example is 1 so the pin will be high for one tick (CPU cycle). The next bit is 0 so the pin will be low for two ticks. The next bit is 1 so the pin will be high again for four ticks and the last bit is also a 1 so the pin will continue being high for another eight ticks. See? As the position of the bit in the binary system determines its value, it is determining the amount of ticks it will applying its value for in BAM.</p>
<p>Using BAM we can actually write these values as decimal ranging from 0–15. Since 15 in decimal is 1111 in binary. This would corespondent to a 100% duty cycle in PWM meaning the LED would be turned on with its full brightness.</p>
<h2 id="the-code">The Code</h2>
<p>Now we understand how PWM and BAM actually work and how they achieve their similar goals very differently it is time to look at some code.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ino" data-lang="ino"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#cd2828;font-weight:bold">#include</span> <span style="color:#cd2828;font-weight:bold">&lt;SPI.h&gt;</span><span style="color:#cd2828;font-weight:bold">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#cd2828;font-weight:bold"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#999;font-style:italic">// define pins and other variables
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">const</span> <span style="color:#6ab825;font-weight:bold">int</span> latchPin = <span style="color:#3677a9">8</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#6ab825;font-weight:bold">const</span> <span style="color:#6ab825;font-weight:bold">int</span> clockPin = <span style="color:#3677a9">13</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#6ab825;font-weight:bold">const</span> <span style="color:#6ab825;font-weight:bold">int</span> dataPin  = <span style="color:#3677a9">11</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#6ab825;font-weight:bold">const</span> <span style="color:#6ab825;font-weight:bold">int</span> NUMBER_OF_CONNECTED_LEDS = <span style="color:#3677a9">16</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#999;font-style:italic">// global array that keeps track of the LEDs brightnesses
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">bool</span> brightnessMask[NUMBER_OF_CONNECTED_LEDS*<span style="color:#3677a9">4</span>];
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span style="color:#999;font-style:italic">// NOTE: some methods are omitted for clarity
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#999;font-style:italic"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#999;font-style:italic">/////////////////
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span style="color:#999;font-style:italic">// BAM methods //
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#999;font-style:italic">/////////////////
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span style="color:#999;font-style:italic"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span style="color:#999;font-style:italic">// convert brightness to bitmasked brightness
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">void</span> <span style="color:#447fcf">led</span>(<span style="color:#6ab825;font-weight:bold">int</span> ledNr, <span style="color:#6ab825;font-weight:bold">int</span> brightness){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span>  <span style="color:#999;font-style:italic">// ensure 4-bit limited brightness
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span style="color:#999;font-style:italic"></span>  brightness = <span style="color:#447fcf">constrain</span>(brightness, <span style="color:#3677a9">0</span>, <span style="color:#3677a9">15</span>);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span>  <span style="color:#999;font-style:italic">// turn 4-bit brightness into brightness mask
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span><span style="color:#999;font-style:italic"></span>  <span style="color:#6ab825;font-weight:bold">for</span> (<span style="color:#6ab825;font-weight:bold">int</span> i = <span style="color:#3677a9">3</span>; i &gt;= <span style="color:#3677a9">0</span>; i--) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span>    <span style="color:#6ab825;font-weight:bold">if</span> (brightness - (<span style="color:#3677a9">1</span> &lt;&lt; i) &gt;= <span style="color:#3677a9">0</span>) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26</span>      brightness -= (<span style="color:#3677a9">1</span> &lt;&lt; i);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27</span>      brightnessMask[(ledNr*<span style="color:#3677a9">4</span>)+i] = <span style="color:#3677a9">1</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">28</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">29</span>    <span style="color:#6ab825;font-weight:bold">else</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">30</span>      brightnessMask[(ledNr*<span style="color:#3677a9">4</span>)+i] = <span style="color:#3677a9">0</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">31</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">32</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">33</span>}
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">34</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">35</span><span style="color:#999;font-style:italic">// transform brighnesses to 4-bit BAM
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">36</span><span style="color:#999;font-style:italic"></span><span style="color:#6ab825;font-weight:bold">void</span> <span style="color:#447fcf">refresh</span>(){
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">37</span>  <span style="color:#999;font-style:italic">// Loop over each LED
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">38</span><span style="color:#999;font-style:italic"></span>  <span style="color:#6ab825;font-weight:bold">for</span> (<span style="color:#6ab825;font-weight:bold">int</span> cycle = <span style="color:#3677a9">0</span>; cycle &lt; <span style="color:#3677a9">16</span>; cycle++) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">39</span>    <span style="color:#6ab825;font-weight:bold">for</span> (<span style="color:#6ab825;font-weight:bold">int</span> currentLed = <span style="color:#3677a9">0</span>; currentLed &lt; NUMBER_OF_CONNECTED_LEDS; currentLed++) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">40</span>      <span style="color:#6ab825;font-weight:bold">int</span> maskPosition = currentLed * <span style="color:#3677a9">4</span>;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">41</span>      <span style="color:#6ab825;font-weight:bold">if</span> (cycle == <span style="color:#3677a9">1</span> &amp;&amp; brightnessMask[maskPosition]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">42</span>        turnOnLed(currentLed);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">43</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">44</span>      <span style="color:#6ab825;font-weight:bold">else</span> <span style="color:#6ab825;font-weight:bold">if</span> ((cycle == <span style="color:#3677a9">2</span> || cycle == <span style="color:#3677a9">3</span>) &amp;&amp; brightnessMask[maskPosition+<span style="color:#3677a9">1</span>]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">45</span>        turnOnLed(currentLed);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">46</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">47</span>      <span style="color:#6ab825;font-weight:bold">else</span> <span style="color:#6ab825;font-weight:bold">if</span> (cycle &gt;= <span style="color:#3677a9">4</span> &amp;&amp; cycle &lt;= <span style="color:#3677a9">7</span> &amp;&amp; brightnessMask[maskPosition+<span style="color:#3677a9">2</span>]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">48</span>        turnOnLed(currentLed);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">49</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">50</span>      <span style="color:#6ab825;font-weight:bold">else</span> <span style="color:#6ab825;font-weight:bold">if</span> (cycle &gt;= <span style="color:#3677a9">8</span> &amp;&amp; cycle &lt;= <span style="color:#3677a9">15</span> &amp;&amp; brightnessMask[maskPosition+<span style="color:#3677a9">3</span>]) {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">51</span>        turnOnLed(currentLed);
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">52</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">53</span>      <span style="color:#6ab825;font-weight:bold">else</span>{
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">54</span>        clearLeds();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">55</span>      }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">56</span>    }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">57</span>  }
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">58</span>  clearLeds();
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">59</span>}
</code></pre></div><p>On line 10 we’re keeping track the brightness of each connected LED using big array called <code>brightnessMask</code>. I couldn’t find a way to create multidimensional arrays in Arduino so I ended up making one big array with the length of four times the number of connected LEDs; four bits for each connected LED.</p>
<p>On line 19 I’ve modified the <code>led()</code> method so it also accepts the brightness of the LED and added some logic which converts a decimal number (0–15) to a 4-bit binary value which get saved in the <code>brightnessMask</code> array afterwards.</p>
<p>The real Bit Angle Modulation magic happens in the <code>refresh()</code> method that starts on line 36. As you see it consists of two loops; the first loop simply loops 15 times, equal to the number of ticks in one 4-bit cycle. The second loop simply iterates over each connected LED in our project.</p>
<p>The first thing that happens within that inner loop is getting the index reference of the first bit for the current LED in the <code>brightnessMask</code>. What follows is basically a series of if-statements checking wether the LED in the current cycle should be turned on or off depending on the boolean in the brightnessMask.</p>
<p>The rest of the code is untouched. The <code>turnOnLed()</code> method is still the same where it shifts out a value to turn on the selected LED and the <code>clearLeds()</code> method still shifts out all zeroes so all LEDs turn off again.</p>
<p>That’s it! This is all we have to do to make Bit Angle Modulation work on an Arduino using shift registers.</p>
<h2 id="demo-video">Demo video</h2>
<p>In my example I’ve written a couple of animations that use the fading effects on my array of LEDs. A link to the full source of this project can be found here and don’t hesitate to send me your video’s of your own animations!</p>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="https://www.youtube.com/embed/1vbBsKNxcDE" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen title="YouTube Video"></iframe>
</div>

<p>Thanks for reading!</p>

    </section>
  </body>
</html>
