<!DOCTYPE html>
<html>
  <head>
    <title>Implementing SHA1 from scratch in Rust ~ Tiemen</title><meta name="viewport" content="width=device-width, initial-scale=1.0" /> <link
rel="stylesheet" href="/css/main.css" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon.svg" />


<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=UA-25416548-1"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());

  gtag("config", "UA-25416548-1");
</script>
<meta property="og:title" content="Implementing SHA1 from scratch in Rust ~ Tiemen" />
    <meta name="twitter:title" content="Implementing SHA1 from scratch in Rust ~ Tiemen" />
    <meta itemprop="name" content="Implementing SHA1 from scratch in Rust ~ Tiemen" />
    <meta name="application-name" content="Implementing SHA1 from scratch in Rust ~ Tiemen" />
    <meta property="og:site_name" content="" />

    <meta name="keywords" content="" />

    <meta name="description" content="Implementing a Secure Hashing Algorithm 1 from scratch in Rust." />
    <meta itemprop="description" content="Implementing a Secure Hashing Algorithm 1 from scratch in Rust." />
    <meta property="og:description" content="Implementing a Secure Hashing Algorithm 1 from scratch in Rust." />
    <meta name="twitter:description" content="Implementing a Secure Hashing Algorithm 1 from scratch in Rust." />

    <link rel="canonical" href="https://tiemenwaterreus.com/posts/implementing-base64-in-rust/" itemprop="url" />
    <meta name="url" content="https://tiemenwaterreus.com/posts/implementing-base64-in-rust/" />
    <meta name="twitter:url" content="https://tiemenwaterreus.com/posts/implementing-base64-in-rust/" />
    <meta property="og:url" content="https://tiemenwaterreus.com/posts/implementing-base64-in-rust/" />
  </head>
  <body>
    <section class="single-post">
      <section class="post-pre-header">
        <a href="/posts" class="bring-me-back">&larr; all posts</a>

        <div class="meta">
          Posted on Aug 4, 2021
          <span class="draft-label">DRAFT</span> 
        </div>
      </section>

      <h1>Implementing SHA1 from scratch in Rust</h1>
      <p>In this article we&rsquo;re taking a closer look at the Base64 algorithm and implement an encoder and decoder from scratch using the Rust programming language. Base64 is quite an easy to grasp algorithm and certainly fun to implement yourself! Let&rsquo;s dive right in!</p>
<h2 id="what-is-base64">What is Base64?</h2>
<p>Base64 is an encoding algorithm that was primarily designed to encode binary data for use in text-based algorithms by using 64 different ASCII characters to represent the bits. For example <a href="https://en.wikipedia.org/wiki/Email_attachment">email attachments</a> or <a href="https://en.wikipedia.org/wiki/Data_URI_scheme">embedding image data</a> directly into a <code>img</code> tag.</p>
<p>Base64 works by breaking up the original binary in chunks of 3 bytes (24 bits) and splitting these 24 bits into 4 groups of 6 bits. These 6 bits translate to a number anywhere from 0 (<code>0b000000</code>) through 63 (<code>0b111111</code>) that are mapped to 64 ASCII characters.</p>
<figure><img src="/resources/base64/encode-explainer.png"
         alt="Base64 encoder schematic"/><figcaption>
            <p>Base64 encoder schematic</p>
        </figcaption>
</figure>

<p>The original Base64 alphabet uses <code>A-Z</code> uppercase, <code>a-z</code> lowercase, the digits <code>0</code> through <code>9</code> and special characters <code>+</code> and <code>/</code>. The <code>=</code> is used for padding at the end of the output string, so that we always end on a multiple of four bytes. This is Base64 in a nutshell, for a thorough deep dive into Base64, give <a href="https://medium.com/swlh/powering-the-internet-with-base64-d823ec5df747">this excellent article</a> a read!</p>
<h2 id="the-puzzle-pieces">The puzzle pieces</h2>
<p>Let&rsquo;s walk through the steps that are required to make encoding into and decoding from Base64 work:</p>
<p><strong>Encoding data</strong> to Base64 is fairly simple:</p>
<ul>
<li>Take the original binary input</li>
<li>Chop this stream up in slices of 3 bytes (24 bits)</li>
<li>Chunk each of these 24 bits again in 6-bit parts</li>
<li>Convert these 6 bits into an index (0-63)</li>
<li>Assign an unique character that can be found at that index in the Base64 table</li>
<li>Append padding characters (<code>=</code>) until we until the total encoded string reaches a multiple of four bytes.</li>
<li>et voila!</li>
</ul>
<p><strong>Decoding</strong> is basically working backwards:</p>
<ul>
<li>Strip off the padding (<code>=</code>)</li>
<li>Iterate over the remaining bytes in chunks of four bytes</li>
<li>Look up each ASCII character in the table to get the original numeric index</li>
<li>From these indexes, take the upper 6 bits and stitch them back together</li>
<li>You end up with a multiple of 8 bits which is your original data</li>
</ul>
<h2 id="lets-get-to-work">Let&rsquo;s get to work!</h2>
<p>Ok, enough theory already! Let&rsquo;s get to work! Let&rsquo;s setup a new Rust project (binary) and implement our first few modules:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span>cargo new base64 --bin
</code></pre></div><h2 id="implementing-an-encoding-alphabet">Implementing an encoding alphabet</h2>
<p>As mentioned previously the default Base64 implementation uses an alphabet containing <code>A-Z</code>, <code>a-z</code>, <code>0-9</code>, <code>+</code> and <code>/</code>. However I want our alphabet to be configurable, enabling us to provide an Emoji-based alphabet instead for example ðŸ‘»</p>
<p>To make it configurable, let&rsquo;s figure out a common API that we can implement our configurable alphabets against. We&rsquo;re describing this API in what Rust calls a <a href="https://doc.rust-lang.org/book/ch10-02-traits.html"><code>trait</code></a> (comparable to an Interface in Java, Go or C#).</p>
<h3 id="defining-our-alphabet-trait">Defining our Alphabet trait</h3>
<p>There are basically three operations that our alphabet should be able to perform; Going from an index to a character, going from a character back to the original 6-bit index and getting the character used for padding.</p>
<p>Let&rsquo;s create a new <code>src/alphabet.rs</code> file inside our project and get going:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">trait</span><span style="color:#666"> </span>Alphabet<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">get_char_for_index</span>(&amp;self,<span style="color:#666"> </span>index: <span style="color:#6ab825;font-weight:bold">u8</span>)<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Option</span>&lt;char&gt;;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">get_index_for_char</span>(&amp;self,<span style="color:#666"> </span>character: <span style="color:#447fcf;text-decoration:underline">char</span>)<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Option</span>&lt;<span style="color:#6ab825;font-weight:bold">u8</span>&gt;;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">get_padding_char</span>(&amp;self)<span style="color:#666"> </span>-&gt; <span style="color:#447fcf;text-decoration:underline">char</span>;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><h3 id="defining-the-classic-base64-alphabet-implementation">Defining the classic Base64 alphabet implementation</h3>
<p>Now that we wrote the contract of what an alphabet should be able to perform, let&rsquo;s create the classic Base64 alphabet first.
Like we talked about in the beginning of this post, the classic alphabet uses <code>a-z</code>, <code>A-Z</code>, <code>0-9</code> plus <code>+</code>, <code>/</code> and <code>=</code> for padding.</p>
<p>We&rsquo;re creating an empty struct and call it <code>Classic</code>, this will act as the type to call the methods on. Let&rsquo;s also supply an implementation for the <code>Alphabet</code> trait and place all this into the same <code>src/alphabet.rs</code> file for now.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#999;font-style:italic">// ... snip trait declaration
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#999;font-style:italic"></span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">struct</span> <span style="color:#447fcf;text-decoration:underline">Classic</span>;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">const</span><span style="color:#666"> </span>UPPERCASEOFFSET: <span style="color:#6ab825;font-weight:bold">i8</span> =<span style="color:#666"> </span><span style="color:#3677a9">65</span>;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">const</span><span style="color:#666"> </span>LOWERCASEOFFSET: <span style="color:#6ab825;font-weight:bold">i8</span> =<span style="color:#666"> </span><span style="color:#3677a9">71</span>;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">const</span><span style="color:#666"> </span>DIGITOFFSET: <span style="color:#6ab825;font-weight:bold">i8</span> =<span style="color:#666"> </span>-<span style="color:#3677a9">4</span>;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">impl</span><span style="color:#666"> </span>Alphabet<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">for</span><span style="color:#666"> </span>Classic<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">get_char_for_index</span>(&amp;self,<span style="color:#666"> </span>index: <span style="color:#6ab825;font-weight:bold">u8</span>)<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Option</span>&lt;char&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>index<span style="color:#666"> </span>=<span style="color:#666"> </span>index<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">as</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">i8</span>;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>ascii_index<span style="color:#666"> </span>=<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">match</span><span style="color:#666"> </span>index<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#666">            </span><span style="color:#3677a9">0</span>..=<span style="color:#3677a9">25</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>index<span style="color:#666"> </span>+<span style="color:#666"> </span>UPPERCASEOFFSET,<span style="color:#666">  </span><span style="color:#999;font-style:italic">// A-Z
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span style="color:#999;font-style:italic"></span><span style="color:#666">            </span><span style="color:#3677a9">26</span>..=<span style="color:#3677a9">51</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>index<span style="color:#666"> </span>+<span style="color:#666"> </span>LOWERCASEOFFSET,<span style="color:#666"> </span><span style="color:#999;font-style:italic">// a-z
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#999;font-style:italic"></span><span style="color:#666">            </span><span style="color:#3677a9">52</span>..=<span style="color:#3677a9">61</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>index<span style="color:#666"> </span>+<span style="color:#666"> </span>DIGITOFFSET,<span style="color:#666">     </span><span style="color:#999;font-style:italic">// 0-9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span style="color:#999;font-style:italic"></span><span style="color:#666">            </span><span style="color:#3677a9">62</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span><span style="color:#3677a9">43</span>,<span style="color:#666">                           </span><span style="color:#999;font-style:italic">// +
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span style="color:#999;font-style:italic"></span><span style="color:#666">            </span><span style="color:#3677a9">63</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span><span style="color:#3677a9">47</span>,<span style="color:#666">                           </span><span style="color:#999;font-style:italic">// /
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span style="color:#999;font-style:italic"></span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span style="color:#666">            </span>_<span style="color:#666"> </span>=&gt;<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span><span style="color:#24909d">None</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span style="color:#666">        </span>}<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">as</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">u8</span>;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span><span style="color:#666">        </span><span style="color:#24909d">Some</span>(ascii_index<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">as</span><span style="color:#666"> </span>char)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span><span style="color:#666">    </span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">get_index_for_char</span>(&amp;self,<span style="color:#666"> </span>character: <span style="color:#447fcf;text-decoration:underline">char</span>)<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Option</span>&lt;<span style="color:#6ab825;font-weight:bold">u8</span>&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27</span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>character<span style="color:#666"> </span>=<span style="color:#666"> </span>character<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">as</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">i8</span>;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">28</span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>base64_index<span style="color:#666"> </span>=<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">match</span><span style="color:#666"> </span>character<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">29</span><span style="color:#666">            </span><span style="color:#3677a9">65</span>..=<span style="color:#3677a9">90</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>character<span style="color:#666"> </span>-<span style="color:#666"> </span>UPPERCASEOFFSET,<span style="color:#666">  </span><span style="color:#999;font-style:italic">// A-Z
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">30</span><span style="color:#999;font-style:italic"></span><span style="color:#666">            </span><span style="color:#3677a9">97</span>..=<span style="color:#3677a9">122</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>character<span style="color:#666"> </span>-<span style="color:#666"> </span>LOWERCASEOFFSET,<span style="color:#666"> </span><span style="color:#999;font-style:italic">// a-z
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">31</span><span style="color:#999;font-style:italic"></span><span style="color:#666">            </span><span style="color:#3677a9">48</span>..=<span style="color:#3677a9">57</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>character<span style="color:#666"> </span>-<span style="color:#666"> </span>DIGITOFFSET,<span style="color:#666">      </span><span style="color:#999;font-style:italic">// 0-9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">32</span><span style="color:#999;font-style:italic"></span><span style="color:#666">            </span><span style="color:#3677a9">43</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span><span style="color:#3677a9">62</span>,<span style="color:#666">                                </span><span style="color:#999;font-style:italic">// +
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">33</span><span style="color:#999;font-style:italic"></span><span style="color:#666">            </span><span style="color:#3677a9">47</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span><span style="color:#3677a9">63</span>,<span style="color:#666">                                </span><span style="color:#999;font-style:italic">// /
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">34</span><span style="color:#999;font-style:italic"></span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">35</span><span style="color:#666">            </span>_<span style="color:#666"> </span>=&gt;<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span><span style="color:#24909d">None</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">36</span><span style="color:#666">        </span>}<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">as</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">u8</span>;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">37</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">38</span><span style="color:#666">        </span><span style="color:#24909d">Some</span>(base64_index)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">39</span><span style="color:#666">    </span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">40</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><p>First things first, we define an <em>empty</em> struct called <code>Classic</code>, such a type in Rust-land is called a <a href="https://doc.rust-lang.org/nomicon/exotic-sizes.html#zero-sized-types-zsts">zero-sized-type</a>. Due to the lack of fields, it will only exist in Rusts type system, once the compiler chewed its way through our code, there will be no trace of this struct anymore! It is however a very neat way of passing trait implementations around and that is why we are using it.</p>
<p>Following the struct declaration are a few constants followed by the implementation of the <code>Alphabet</code> trait on our <code>Classic</code> struct. The implementation itself makes use of the fact that characters in the ASCII alphabet are defined <em>mostly</em> in sequence. For example: <code>A</code> through <code>Z</code> uppercased have indexes 65 through 90, the same is true for both <code>a</code> through <code>z</code> lowercased and the digits <code>0</code> through <code>9</code>.</p>
<p>We make use of this by pre-calculating an offset between our Base64 index (0-63) and the index in the ASCII alphabet (65-90, 97-122, etc). Then using the <code>match</code> operator match on a specific range, apply the correct offset and return the result as a byte.</p>
<p>Mission accomplished ðŸ’ª</p>
<h2 id="building-the-encoder-">Building the Encoder! ðŸ™Œ</h2>
<p>Now that we have defined how our alphabet should work, let&rsquo;s get on to building the encoder part of our project. We&rsquo;ll create a new module inside <code>src/encoder.rs</code> and bring the <code>Alphabet</code> trait and <code>Classic</code> implementation into scope:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#6ab825;font-weight:bold">use</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">crate</span>::alphabet::{Alphabet,<span style="color:#666"> </span>Classic};<span style="color:#666">
</span></code></pre></div><p>The next step is setting up a few smaller functions that will take on the heavy lifting of the encoding part.</p>
<h3 id="splitting-it-up">Splitting it up!</h3>
<p>Let&rsquo;s start with our split function:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">split</span>(chunk: <span style="color:#6ab825">&amp;</span>[<span style="color:#6ab825;font-weight:bold">u8</span>])<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Vec</span>&lt;<span style="color:#6ab825;font-weight:bold">u8</span>&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">match</span><span style="color:#666"> </span>chunk.len()<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#666">        </span><span style="color:#3677a9">1</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>vec![<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#666">            </span>&amp;chunk[<span style="color:#3677a9">0</span>]<span style="color:#666"> </span>&gt;&gt;<span style="color:#666"> </span><span style="color:#3677a9">2</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#666">            </span>(&amp;chunk[<span style="color:#3677a9">0</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00000011</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">4</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#666">        </span>],<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#666">        </span><span style="color:#3677a9">2</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>vec![<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#666">            </span>&amp;chunk[<span style="color:#3677a9">0</span>]<span style="color:#666"> </span>&gt;&gt;<span style="color:#666"> </span><span style="color:#3677a9">2</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#666">            </span>(&amp;chunk[<span style="color:#3677a9">0</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00000011</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">4</span><span style="color:#666"> </span>|<span style="color:#666"> </span>&amp;chunk[<span style="color:#3677a9">1</span>]<span style="color:#666"> </span>&gt;&gt;<span style="color:#666"> </span><span style="color:#3677a9">4</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span style="color:#666">            </span>(&amp;chunk[<span style="color:#3677a9">1</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00001111</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">2</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span style="color:#666">        </span>],<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#666">        </span><span style="color:#3677a9">3</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>vec![<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span style="color:#666">            </span>&amp;chunk[<span style="color:#3677a9">0</span>]<span style="color:#666"> </span>&gt;&gt;<span style="color:#666"> </span><span style="color:#3677a9">2</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#666">            </span>(&amp;chunk[<span style="color:#3677a9">0</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00000011</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">4</span><span style="color:#666"> </span>|<span style="color:#666"> </span>&amp;chunk[<span style="color:#3677a9">1</span>]<span style="color:#666"> </span>&gt;&gt;<span style="color:#666"> </span><span style="color:#3677a9">4</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span style="color:#666">            </span>(&amp;chunk[<span style="color:#3677a9">1</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00001111</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">2</span><span style="color:#666"> </span>|<span style="color:#666"> </span>&amp;chunk[<span style="color:#3677a9">2</span>]<span style="color:#666"> </span>&gt;&gt;<span style="color:#666"> </span><span style="color:#3677a9">6</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span style="color:#666">            </span>&amp;chunk[<span style="color:#3677a9">2</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00111111</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span style="color:#666">        </span>],<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span style="color:#666">        </span>_<span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>unreachable!()<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span><span style="color:#666">    </span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><p>As you can see in the function signature, the <code>split</code> function takes a slice of bytes (<code>&amp;[u8]</code>) and returns a <code>Vec&lt;u8&gt;</code>. It converts the input of up-to 3 bytes into an output of up-to 4 bytes. Essentially converting the 8-bit unsigned integers into 6-bit.</p>
<p>To achieve this, we use bitwise operations to shuffle the bits around. In case of a 1-byte input, we return two bytes where the first 6 bits of the input byte are returned as the first output byte, the last two bits of the input byte are returned as the second byte. In case of a 3 byte input, we follow the same kind of steps to piece different parts of the bytes together to form 4 output bytes each holding 6 bits of information.</p>
<h3 id="encoding-using-our-alphabet">Encoding using our Alphabet</h3>
<p>Now that we have a mechanism to convert from 8-bit numbers to 6-bit numbers, let&rsquo;s slice the input data into 3-byte chunks and run them through our split function. Once they&rsquo;re split, we can convert each chunk by looking up the 6-bit number in our alphabet:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">encode_using_alphabet</span>&lt;T: <span style="color:#447fcf;text-decoration:underline">Alphabet</span>&gt;(alphabet: <span style="color:#6ab825">&amp;</span><span style="color:#447fcf;text-decoration:underline">T</span>,<span style="color:#666"> </span>data: <span style="color:#6ab825">&amp;</span>[<span style="color:#6ab825;font-weight:bold">u8</span>])<span style="color:#666"> </span>-&gt; <span style="color:#24909d">String</span> {<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>encoded<span style="color:#666"> </span>=<span style="color:#666"> </span>data<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span><span style="color:#666">        </span>.chunks(<span style="color:#3677a9">3</span>)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4</span><span style="color:#666">        </span>.map(split)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5</span><span style="color:#666">        </span>.flat_map(|chunk|<span style="color:#666"> </span>encode_chunk(alphabet,<span style="color:#666"> </span>chunk));<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7</span><span style="color:#666">    </span><span style="color:#24909d">String</span>::from_iter(encoded)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">8</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><p>The <code>encode_with_alphabet</code> function shown above takes the alphabet to encode against en the original input string to encode. The first step is to slide the input in 3-byte chunks and feeding it into our <code>split</code> function that will return a <code>Vec&lt;u8&gt;</code> of maximum 4-bytes.</p>
<p>Passing each 6-bit number to <code>encode_chunk</code> using <code>flat_map</code> will ensure we&rsquo;re flattening the <code>Vec&lt;char&gt;</code> while we&rsquo;re at it and lastly we consume the iterator by passing it to <code>String::from_iter</code>!</p>
<p>Note: For that last trick (using <code>String::from_iter</code> to build a string from an iterator) to work, we&rsquo;ll need to bring <code>FromIterator</code> trait into scope, see:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#6ab825;font-weight:bold">use</span><span style="color:#666"> </span>std::iter::FromIterator;<span style="color:#666">
</span></code></pre></div><h3 id="encode_chunk-internals">encode_chunk internals</h3>
<p>As promised, let&rsquo;s zoom in a bit on the <code>encode_chunk</code> function we&rsquo;re using above. The function signature tells us that this function will take anything that implements the Alphabet trait (which our Classic alphabet does) and a chunk of our bytes (more specifically the <code>Vec&lt;u8&gt;</code> that came rolling out of the <code>split</code> function earlier.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">encode_chunk</span>&lt;T: <span style="color:#447fcf;text-decoration:underline">Alphabet</span>&gt;(alphabet: <span style="color:#6ab825">&amp;</span><span style="color:#447fcf;text-decoration:underline">T</span>,<span style="color:#666"> </span>chunk: <span style="color:#24909d">Vec</span>&lt;<span style="color:#6ab825;font-weight:bold">u8</span>&gt;)<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Vec</span>&lt;char&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">mut</span><span style="color:#666"> </span>out<span style="color:#666"> </span>=<span style="color:#666"> </span>vec![alphabet.get_padding_char();<span style="color:#666"> </span><span style="color:#3677a9">4</span>];<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">for</span><span style="color:#666"> </span>i<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">in</span><span style="color:#666"> </span><span style="color:#3677a9">0</span>..chunk.len()<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">if</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span><span style="color:#24909d">Some</span>(chr)<span style="color:#666"> </span>=<span style="color:#666"> </span>alphabet.get_char_for_index(chunk[i])<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#666">            </span>out[i]<span style="color:#666"> </span>=<span style="color:#666"> </span>chr;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#666">        </span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#666">    </span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#666">    </span>out<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><p>This function starts off by setting up a <code>Vec&lt;char&gt;</code> that acts as our output buffer, to make our lives easier we&rsquo;re pre filling the buffer with 4 padding characters. Note that we tagged the buffer as mutable so we can overwrite the padding characters with actual data as we&rsquo;re going along.</p>
<p>Inside our loop we take the 6-bit number, look up the character in our alphabet by index and replace the padding symbol with the actual data, if available. At the end of the loop we just return the output buffer.</p>
<p>That&rsquo;s it! That&rsquo;s all there is to do to get your data Base64 encoded! I wont bore you with the tests but for those interested, <a href="https://github.com/Tmw/base64-rs/blob/master/src/decoder.rs#L64-L87">check em out on the repo</a></p>
<h2 id="decoding">Decoding</h2>
<p>Now that we can turn any arbitrary binary blob into a easy-to-transmit Base64 string, we obviously want to retrieve our original data from the encoded blob, otherwise we just built a data corrupter ;)</p>
<p>Let&rsquo;s implement our decoder in a separate module in <code>src/decoder.rs</code>. Much like with our encoder we&rsquo;re going to need our <em>Alphabet</em> trait together with our <em>Classic</em> implementation. Let&rsquo;s bring these into scope, like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#6ab825;font-weight:bold">use</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">crate</span>::alphabet::{Alphabet,<span style="color:#666"> </span>Classic};<span style="color:#666">
</span></code></pre></div><p>Let&rsquo;s dive right in and define a <code>decode_using_alpabet</code> function that, much like our <code>encode_using_alphabet</code> function takes the alphabet to do the decoding against and the encoded string to perform the decoding on.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#6ab825;font-weight:bold">pub</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">decode_using_alphabet</span>&lt;T: <span style="color:#447fcf;text-decoration:underline">Alphabet</span>&gt;(alphabet: <span style="color:#447fcf;text-decoration:underline">T</span>,<span style="color:#666"> </span>data: <span style="color:#6ab825">&amp;</span><span style="color:#24909d">String</span>)<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Result</span>&lt;<span style="color:#24909d">Vec</span>&lt;<span style="color:#6ab825;font-weight:bold">u8</span>&gt;,<span style="color:#666"> </span>io::Error&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#666">    </span><span style="color:#999;font-style:italic">// if data is not multiple of four bytes, data is invalid
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#999;font-style:italic"></span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">if</span><span style="color:#666"> </span>data.chars().count()<span style="color:#666"> </span>%<span style="color:#666"> </span><span style="color:#3677a9">4</span><span style="color:#666"> </span>!=<span style="color:#666"> </span><span style="color:#3677a9">0</span><span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span><span style="color:#24909d">Err</span>(io::Error::from(io::ErrorKind::InvalidInput))<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#666">    </span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>result<span style="color:#666"> </span>=<span style="color:#666"> </span>data<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#666">        </span>.chars()<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#666">        </span>.collect::&lt;<span style="color:#24909d">Vec</span>&lt;char&gt;&gt;()<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#666">        </span>.chunks(<span style="color:#3677a9">4</span>)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span style="color:#666">        </span>.map(|chunk|<span style="color:#666"> </span>original(&amp;alphabet,<span style="color:#666"> </span>chunk)<span style="color:#666"> </span>)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span style="color:#666">        </span>.flat_map(stitch)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#666">        </span>.collect()<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span style="color:#666">    </span><span style="color:#24909d">Ok</span>(result)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><p>The first thing we do is run a quick check if the data is indeed a multiple of four bytes, which is one of the characteristics of base64 encoded data. If it does not match these requirements, we&rsquo;ll return an error. When the data is valid, we split the string into its <code>chars</code> and slice it in chunks of 4 <code>char</code>&rsquo;s. Each slice is fed through the <code>original</code> function that will fetch the original char from the alphabet which is <code>flat_map</code>&lsquo;ed through the stitch function.</p>
<h3 id="getting-the-original">Getting the original</h3>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">original</span>&lt;T: <span style="color:#447fcf;text-decoration:underline">Alphabet</span>&gt;(alphabet: <span style="color:#6ab825">&amp;</span><span style="color:#447fcf;text-decoration:underline">T</span>,<span style="color:#666"> </span>chunk: <span style="color:#6ab825">&amp;</span>[char])<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Vec</span>&lt;<span style="color:#6ab825;font-weight:bold">u8</span>&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#666">    </span>chunk<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#666">        </span>.iter()<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#666">        </span>.filter(|character|<span style="color:#666"> </span>*character<span style="color:#666"> </span>!=<span style="color:#666"> </span>&amp;alphabet.get_padding_char())<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#666">        </span>.map(|character|<span style="color:#666"> </span>{<span style="color:#666"> 
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#666">            </span>alphabet<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#666">                </span>.get_index_for_char(*character)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#666">                </span>.expect(<span style="color:#ed9d13">&#34;unable to find character in alphabet&#34;</span>)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#666">        </span>})<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#666">        </span>.collect()<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><p>The <code>original</code> function takes an Alphabet trait object again and a slice of chars (maximum of 4-bytes). It filters the padding characters and uses the looks up the left-over characters in our alphabet. Returning a <code>Vec</code> of bytes as the original data.</p>
<h3 id="stitch-it-back-together">Stitch it back together</h3>
<p>Pretty much as a reverse of <code>split</code> we&rsquo;re taking the various bits from two or more bytes and put it back together much like a carefully constructed Lego Millennium Falcon. It takes a <code>Vec</code> of bytes and returns another <code>Vec</code> of bytes, containing a maximum of three 8-bit numbers.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">stitch</span>(bytes: <span style="color:#24909d">Vec</span>&lt;<span style="color:#6ab825;font-weight:bold">u8</span>&gt;)<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Vec</span>&lt;<span style="color:#6ab825;font-weight:bold">u8</span>&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>out<span style="color:#666"> </span>=<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">match</span><span style="color:#666"> </span>bytes.len()<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#666">        </span><span style="color:#3677a9">2</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>vec![<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#666">            </span>(bytes[<span style="color:#3677a9">0</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00111111</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">2</span><span style="color:#666"> </span>|<span style="color:#666"> </span>bytes[<span style="color:#3677a9">1</span>]<span style="color:#666"> </span>&gt;&gt;<span style="color:#666"> </span><span style="color:#3677a9">4</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#666">            </span>(bytes[<span style="color:#3677a9">1</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00001111</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">4</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#666">        </span>],<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#666">        </span><span style="color:#3677a9">3</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>vec![<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#666">            </span>(bytes[<span style="color:#3677a9">0</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00111111</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">2</span><span style="color:#666"> </span>|<span style="color:#666"> </span>bytes[<span style="color:#3677a9">1</span>]<span style="color:#666"> </span>&gt;&gt;<span style="color:#666"> </span><span style="color:#3677a9">4</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#666">            </span>(bytes[<span style="color:#3677a9">1</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00001111</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">4</span><span style="color:#666"> </span>|<span style="color:#666"> </span>bytes[<span style="color:#3677a9">2</span>]<span style="color:#666"> </span>&gt;&gt;<span style="color:#666"> </span><span style="color:#3677a9">2</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span style="color:#666">            </span>(bytes[<span style="color:#3677a9">2</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00000011</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">6</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span style="color:#666">        </span>],<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#666">        </span><span style="color:#3677a9">4</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>vec![<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span style="color:#666">            </span>(bytes[<span style="color:#3677a9">0</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00111111</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">2</span><span style="color:#666"> </span>|<span style="color:#666"> </span>bytes[<span style="color:#3677a9">1</span>]<span style="color:#666"> </span>&gt;&gt;<span style="color:#666"> </span><span style="color:#3677a9">4</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#666">            </span>(bytes[<span style="color:#3677a9">1</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00001111</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">4</span><span style="color:#666"> </span>|<span style="color:#666"> </span>bytes[<span style="color:#3677a9">2</span>]<span style="color:#666"> </span>&gt;&gt;<span style="color:#666"> </span><span style="color:#3677a9">2</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span style="color:#666">            </span>(bytes[<span style="color:#3677a9">2</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00000011</span>)<span style="color:#666"> </span>&lt;&lt;<span style="color:#666"> </span><span style="color:#3677a9">6</span><span style="color:#666"> </span>|<span style="color:#666"> </span>bytes[<span style="color:#3677a9">3</span>]<span style="color:#666"> </span>&amp;<span style="color:#666"> </span><span style="color:#3677a9">0b00111111</span>,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span style="color:#666">        </span>],<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span style="color:#666">        </span>_<span style="color:#666"> </span>=&gt;<span style="color:#666"> </span>unreachable!()<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span style="color:#666">    </span>};<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span><span style="color:#666">    </span>out.into_iter().filter(|&amp;x|<span style="color:#666"> </span>x<span style="color:#666"> </span>&gt;<span style="color:#666"> </span><span style="color:#3677a9">0</span>).collect()<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><p>And this is how that looks in a schematic:
<figure><img src="/resources/base64/decode-explainer.png"
         alt="Base64 decoder schematic"/><figcaption>
            <p>Base64 decoder schematic</p>
        </figcaption>
</figure>
</p>
<p>Nice! The encoder and decoder are done! For completeness we obviously also <a href="https://github.com/Tmw/base64-rs/blob/master/src/decoder.rs#L60:L84">included tests</a> for our decoder âœ¨âœ¨</p>
<h2 id="piecing-it-together">Piecing it together</h2>
<p>Notice that we wrote all these pieces but our <code>fn main()</code> still has the placeholder <code>println!(&quot;Hello, world!&quot;);</code> in it? This is obviously unacceptable, so let&rsquo;s get back to it and crank out a simple CLI that will take a command line argument and read from STDIN ðŸ’ª</p>
<p>First things first; let&rsquo;s convert our <code>fn main()</code> function so that it will return a <code>Result</code> type. We do this to make our lives easier in terms of error handling, you&rsquo;ll see why in a bit!</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">main</span>()<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Result</span>&lt;(),<span style="color:#666"> </span>CLIError&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><p>Notice that we&rsquo;re returning an empty tuple (or <code>unit</code> in Rust) for the success type and a <code>CLIError</code> as the error type, however we have not yet defined our CLIError. Let&rsquo;s do that right now before the compiler yells at us:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#6ab825;font-weight:bold">use</span><span style="color:#666"> </span>std::fmt;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">enum</span> <span style="color:#447fcf;text-decoration:underline">CLIError</span><span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#666">    </span>TooLittleArguments,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#666">    </span>InvalidSubcommand(<span style="color:#24909d">String</span>),<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#666">    </span>StdInUnreadable,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#666">    </span>DecodingError,<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">impl</span><span style="color:#666"> </span>std::fmt::Debug<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">for</span><span style="color:#666"> </span>CLIError<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">fmt</span>(&amp;self,<span style="color:#666"> </span>f: <span style="color:#6ab825">&amp;</span><span style="color:#447fcf;text-decoration:underline">mut</span><span style="color:#666"> </span>fmt::Formatter&lt;<span style="color:#bbb">&#39;_</span>&gt;)<span style="color:#666"> </span>-&gt; <span style="color:#447fcf;text-decoration:underline">fmt</span>::<span style="color:#24909d">Result</span><span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">match</span><span style="color:#666"> </span>&amp;self<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#666">            </span>Self::TooLittleArguments<span style="color:#666"> </span>=&gt;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#666">                </span>write!(f,<span style="color:#666"> </span><span style="color:#ed9d13">&#34;Too little arguments provided&#34;</span>),<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#666">            </span>Self::InvalidSubcommand(cmd)<span style="color:#666"> </span>=&gt;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span style="color:#666">                </span>write!(f,<span style="color:#666"> </span><span style="color:#ed9d13">&#34;Invalid subcommand provided: \&#34;{}\&#34;&#34;</span>,<span style="color:#666"> </span>cmd),<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span style="color:#666">            </span>Self::StdInUnreadable<span style="color:#666"> </span>=&gt;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span style="color:#666">                </span>write!(f,<span style="color:#666"> </span><span style="color:#ed9d13">&#34;Unable to read STDIN&#34;</span>),<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span><span style="color:#666">            </span>Self::DecodingError<span style="color:#666"> </span>=&gt;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span><span style="color:#666">                </span>write!(f,<span style="color:#666"> </span><span style="color:#ed9d13">&#34;An error occured while decoding the data&#34;</span>),<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span><span style="color:#666">        </span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span><span style="color:#666">    </span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><p>In the code above we define the <code>enum CLIError</code> that describes pretty much everything that can go wrong when calling our binary. For example; for whatever reason reading from the STDIN is not successful or we&rsquo;re calling our executable without providing a valid subcommand. Notice that in the case of the unknown subcommand we&rsquo;re also keeping track of what exactly is passed, giving our users a bit more context around the error.</p>
<p>Notice that next to defining our <code>CLIError</code> we also make it implement the Debug trait. This trait pretty much describes how the variants inside the enum can be turned into a printable string when returned as part of the error type.</p>
<p>The next step is writing a few functions that will make reading from STDIN, encoding and decoding a bit easier:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#6ab825;font-weight:bold">use</span><span style="color:#666"> </span>std::io::{self,<span style="color:#666"> </span>Read};<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">read_stdin</span>()<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Result</span>&lt;<span style="color:#24909d">String</span>,<span style="color:#666"> </span>CLIError&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">mut</span><span style="color:#666"> </span>input<span style="color:#666"> </span>=<span style="color:#666"> </span><span style="color:#24909d">String</span>::new();<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#666">    </span>io::stdin()<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#666">        </span>.read_to_string(&amp;<span style="color:#6ab825;font-weight:bold">mut</span><span style="color:#666"> </span>input)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#666">        </span>.map_err(|_|<span style="color:#666"> </span>CLIError::StdInUnreadable)?;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#666">    </span><span style="color:#24909d">Ok</span>(input.trim().to_string())<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">encode</span>(input: <span style="color:#6ab825">&amp;</span><span style="color:#24909d">String</span>)<span style="color:#666"> </span>-&gt; <span style="color:#24909d">String</span> {<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#666">    </span>encoder::encode(input.as_bytes())<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#666"></span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">decode</span>(input: <span style="color:#6ab825">&amp;</span><span style="color:#24909d">String</span>)<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Result</span>&lt;<span style="color:#24909d">String</span>,<span style="color:#666"> </span>CLIError&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>decoded<span style="color:#666"> </span>=<span style="color:#666"> </span>decoder::decode(input).map_err(|_|<span style="color:#666"> </span>CLIError::DecodingError)?;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>decoded_as_string<span style="color:#666"> </span>=<span style="color:#666"> </span>std::<span style="color:#6ab825;font-weight:bold">str</span>::from_utf8(&amp;decoded)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span style="color:#666">        </span>.map_err(|_|<span style="color:#666"> </span>CLIError::DecodingError)?;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span><span style="color:#666">    </span><span style="color:#24909d">Ok</span>(decoded_as_string.to_owned())<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><p>Note the <code>read_from_stdin</code> function also returns a <code>Result&lt;String, CLIError&gt;</code>. It will attempt to read from STDIN and write the contents to a string. If this succeeds it will return the <code>Ok</code> variant with the string value, but if this fails, we will map the error to a <code>CLIError::StdInUnreadable</code> error which will be pretty printed in our console.</p>
<p>The next two functions (<code>encode</code> and <code>decode</code>) are pretty much just wrappers around our library functions <code>encoder</code> and <code>decoder</code> that will take in a reference to a string and return a owned string. To ensure we are able to use our encoder and decoder modules, let&rsquo;s link them to the main executable:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#6ab825;font-weight:bold">mod</span> <span style="color:#447fcf;text-decoration:underline">alphabet</span>;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">mod</span> <span style="color:#447fcf;text-decoration:underline">decoder</span>;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span><span style="color:#666"></span><span style="color:#6ab825;font-weight:bold">mod</span> <span style="color:#447fcf;text-decoration:underline">encoder</span>;<span style="color:#666">
</span></code></pre></div><p>Final stretch! Let&rsquo;s fill in our <code>main()</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#6ab825;font-weight:bold">fn</span> <span style="color:#447fcf">main</span>()<span style="color:#666"> </span>-&gt; <span style="color:#24909d">Result</span>&lt;(),<span style="color:#666"> </span>CLIError&gt;<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">if</span><span style="color:#666"> </span>std::env::args().count()<span style="color:#666"> </span>&lt;<span style="color:#666"> </span><span style="color:#3677a9">2</span><span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#666">        </span><span style="color:#6ab825;font-weight:bold">return</span><span style="color:#666"> </span><span style="color:#24909d">Err</span>(CLIError::TooLittleArguments);<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#666">    </span>}<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>subcommand<span style="color:#666"> </span>=<span style="color:#666"> </span>std::env::args()<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#666">        </span>.nth(<span style="color:#3677a9">1</span>)<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#666">        </span>.ok_or_else(||<span style="color:#666"> </span>CLIError::TooLittleArguments)?;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>input<span style="color:#666"> </span>=<span style="color:#666"> </span>read_stdin()?;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span style="color:#666">    </span><span style="color:#6ab825;font-weight:bold">let</span><span style="color:#666"> </span>output<span style="color:#666"> </span>=<span style="color:#666"> </span><span style="color:#6ab825;font-weight:bold">match</span><span style="color:#666"> </span>subcommand.as_str()<span style="color:#666"> </span>{<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#666">        </span><span style="color:#ed9d13">&#34;encode&#34;</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span><span style="color:#24909d">Ok</span>(encode(&amp;input)),<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#666">        </span><span style="color:#ed9d13">&#34;decode&#34;</span><span style="color:#666"> </span>=&gt;<span style="color:#666"> </span><span style="color:#24909d">Ok</span>(decode(&amp;input)?),<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span style="color:#666">        </span>cmd<span style="color:#666"> </span>=&gt;<span style="color:#666"> </span><span style="color:#24909d">Err</span>(CLIError::InvalidSubcommand(cmd.to_string())),<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#666">    </span>}?;<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span style="color:#666">    </span>print!(<span style="color:#ed9d13">&#34;{}&#34;</span>,<span style="color:#666"> </span>output);<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span style="color:#666">    </span><span style="color:#24909d">Ok</span>(())<span style="color:#666">
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span style="color:#666"></span>}<span style="color:#666">
</span></code></pre></div><p>As you can see we can make a functional CLI within just a few lines of pure Rust without pulling in external dependencies. By using the <code>Result&lt;T, E&gt;</code> type and the question mark operator (<code>?</code>) we&rsquo;re essentially short-circuiting the returned <code>Result</code> types only continuing down the happy path, or returning the error as the return value of the containing function in case of an error.</p>
<p>That is it! That is all we need to make a fully functioning Base64 implementation from scratch in Rust and wrap it in a CLI tool. Usage:</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#999;font-style:italic"># encoding</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;fluffy pancakes&#34;</span> | cargo run -- encode
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span>&gt; Zmx1ZmZ5IHBhbmNha2Vz
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5</span><span style="color:#999;font-style:italic"># and the reverse</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6</span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#34;Zmx1ZmZ5IHBhbmNha2Vz&#34;</span> | cargo run -- decode
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7</span>&gt; fluffy pancakes
</code></pre></div><p>Thank you for reading!</p>

    </section>
  </body>
</html>
